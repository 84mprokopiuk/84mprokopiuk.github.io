<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Log temperatury z QR</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    /* ===== HEADER z LOGO ===== */
    .header {
      background: #000;
      border-radius: 8px;
      padding: 16px 0 12px;
      margin-bottom: 16px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .logo-wrap {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .logo-wrap svg {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .logo-sub {
      color: #fff;
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.3rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.2rem;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .info-row {
      margin: 4px 0;
    }
    .info-label {
      font-weight: 600;
    }
    .error {
      color: #b00020;
      font-weight: 600;
      margin-top: 8px;
    }
    .ok {
      color: #2e7d32;
      font-weight: 600;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 4px;
    }
    .controls input[type="text"] {
      flex: 1 1 260px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: monospace;
      font-size: 0.85rem;
    }

    /* WIĘKSZE PRZYCISKI + IKONKI */
    button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      background: #000;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      min-width: 160px;
      justify-content: center;
    }
    button:hover {
      background: #333;
    }
    .btn-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      display: inline-block;
    }

    .small {
      font-size: 0.8rem;
      color: #555;
    }
  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="logo-wrap">
      <!-- OUTBOX SVG – LITERY OSOBNO -->
      <svg width="340" height="56" viewBox="0 0 340 56" xmlns="http://www.w3.org/2000/svg">
        <g fill="#ffffff">
          <!-- O -->
          <rect x="0" y="0" width="48" height="48"/>
          <rect x="10" y="10" width="28" height="28" fill="#000"/>
          <!-- U -->
          <rect x="60" y="0" width="10" height="48"/>
          <rect x="60" y="38" width="34" height="10"/>
          <rect x="84" y="0" width="10" height="48"/>
          <!-- T -->
          <rect x="108" y="0" width="48" height="10"/>
          <rect x="127" y="0" width="10" height="48"/>
          <!-- B -->
          <rect x="168" y="0" width="10" height="48"/>
          <rect x="168" y="0" width="34" height="10"/>
          <rect x="168" y="19" width="34" height="10"/>
          <rect x="168" y="38" width="34" height="10"/>
          <rect x="202" y="10" width="10" height="9"/>
          <rect x="202" y="29" width="10" height="9"/>
          <!-- O -->
          <rect x="224" y="0" width="48" height="48"/>
          <rect x="234" y="10" width="28" height="28" fill="#000"/>
          <!-- X (przesunięty w prawo) -->
          <polygon points="302,0 316,0 280,48 266,48"/>
          <polygon points="266,0 280,0 316,48 302,48"/>
        </g>
      </svg>
      <!-- SUBTITLE -->
      <div class="logo-sub">datalogger recording</div>
    </div>
  </div>

  <!-- KARTA: PRZYCISKI FUNKCJONALNE -->
  <div class="card">
    <div class="controls">
      <button id="btnPrint">
        <!-- IKONA DRUKARKI -->
        <svg class="btn-icon" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="5" width="14" height="9" rx="1" fill="none" stroke="#ffffff" stroke-width="1.6"/>
          <rect x="6" y="2" width="8" height="4" rx="1" fill="none" stroke="#ffffff" stroke-width="1.6"/>
          <circle cx="7" cy="9" r="1" fill="#ffffff"/>
        </svg>
        <span>Drukuj dane</span>
      </button>

      <button id="btnSendLink">
        <!-- IKONA KOPERTY -->
        <svg class="btn-icon" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="2.5" y="4.5" width="15" height="11" rx="1.2" fill="none" stroke="#ffffff" stroke-width="1.6"/>
          <polyline points="3,5 10,11 17,5" fill="none" stroke="#ffffff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Wyślij link</span>
      </button>
    </div>
  </div>

  <!-- KARTA: TEST INTEGRALNOŚCI -->
  <div class="card">
    <h2>Test integralności danych</h2>
    <div class="small">
      Wynik testu zgodności danych z wydruku QR z zapisanym w nim kodem kontrolnym CRC32.
    </div>
    <div id="errorBox" class="error" style="display:none;"></div>
    <div id="integrityBox" class="ok" style="display:none;"></div>
  </div>

  <div class="card">
    <h2>Informacje o logu</h2>
    <div class="info-row"><span class="info-label">Data:</span> <span id="infoDate">–</span></div>
    <div class="info-row"><span class="info-label">Rejestracja:</span> <span id="infoRej">–</span></div>
    <div class="info-row"><span class="info-label">Interwał logu:</span> <span id="infoInterval">–</span></div>
    <div class="info-row"><span class="info-label">Próbek w QR (baza+alarmy):</span> <span id="infoSamples">–</span></div>
  </div>

  <div class="card">
    <h2>Tabela temperatur (co 15 min)</h2>
    <div id="tableContainer">
      Brak danych – strona powinna zostać otwarta z linku w kodzie QR rejestratora.
    </div>
  </div>

<script>
  function showError(msg) {
    const box = document.getElementById('errorBox');
    const ibox = document.getElementById('integrityBox');
    box.textContent = msg || '';
    box.style.display = msg ? 'block' : 'none';
    if (msg) {
      ibox.textContent = '';
      ibox.style.display = 'none';
    }
  }

  function showIntegrity(msg) {
    const ibox = document.getElementById('integrityBox');
    ibox.textContent = msg || '';
    ibox.style.display = msg ? 'block' : 'none';
  }

  function clearInfo() {
    document.getElementById('infoDate').textContent = '–';
    document.getElementById('infoRej').textContent = '–';
    document.getElementById('infoInterval').textContent = '–';
    document.getElementById('infoSamples').textContent = '–';
    document.getElementById('tableContainer').innerHTML =
      'Brak danych – strona powinna zostać otwarta z linku w kodzie QR rejestratora.';
    showIntegrity('');
  }

  function getBParamFromHash(rawHash) {
    if (!rawHash) return null;
    let h = rawHash;
    if (h.startsWith('#')) h = h.substring(1);
    if (!h) return null;

    if (h.includes('=')) {
      const parts = h.split('&');
      for (const part of parts) {
        const [k, v] = part.split('=');
        if (k === 'b') {
          return v ? decodeURIComponent(v) : '';
        }
      }
      return null;
    }

    const parts = h.split('.');
    const b64 = parts[0] || '';
    return b64 || null;
  }

  function getRParamFromHash(rawHash) {
    if (!rawHash) return null;
    let h = rawHash;
    if (h.startsWith('#')) h = h.substring(1);
    if (!h) return null;

    if (h.includes('=')) {
      const parts = h.split('&');
      for (const part of parts) {
        const [k, v] = part.split('=');
        if (k === 'r') {
          return v ? decodeURIComponent(v) : '';
        }
      }
      return null;
    }

    const parts = h.split('.');
    if (parts.length >= 2 && parts[1].length > 0) {
      return parts[1];
    }
    return null;
  }

  function base64ToBytes(b64like) {
    if (!b64like) {
      return new Uint8Array(0);
    }

    let s = b64like;
    s = s.replace(/-/g, '+').replace(/_/g, '/');
    while (s.length % 4 !== 0) {
      s += '=';
    }

    const binStr = atob(s);
    const len = binStr.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binStr.charCodeAt(i) & 0xFF;
    }
    return bytes;
  }

  function crc32(bytes) {
    let crc = 0xFFFFFFFF >>> 0;
    const len = bytes.length;
    for (let i = 0; i < len; i++) {
      crc ^= bytes[i];
      for (let b = 0; b < 8; b++) {
        if (crc & 1) {
          crc = (crc >>> 1) ^ 0xEDB88320;
        } else {
          crc = crc >>> 1;
        }
      }
    }
    crc = (~crc) >>> 0;
    return crc >>> 0;
  }

  function decodePayload(bytes) {
    if (!bytes || bytes.length < 4) {
      throw new Error('Za mało danych (nagłówek krótszy niż 4 bajty).');
    }

    const yearOff    = bytes[0];
    const year       = 2000 + yearOff;
    const month      = bytes[1];
    const day        = bytes[2];
    const intervalMin = bytes[3];

    if (intervalMin === 0) {
      throw new Error('Interwał = 0 w nagłówku.');
    }
    if (60 % intervalMin !== 0 || 1440 % intervalMin !== 0) {
      throw new Error('Interwał z nagłówka nie dzieli 60/1440.');
    }

    const slotsPerHour = 60 / intervalMin;
    const totalSlotsPerDay = 1440 / intervalMin;

    const samples = [];
    let i = 4;
    while (i + 2 < bytes.length) {
      const slot  = bytes[i++];
      const t1Enc = bytes[i++];
      const t2Enc = bytes[i++];

      if (slot >= totalSlotsPerDay) {
        continue;
      }

      const hour   = Math.floor(slot / slotsPerHour);
      const within = slot % slotsPerHour;
      const minute = within * intervalMin;

      const t1 = t1Enc - 40;
      const t2 = t2Enc - 40;

      samples.push({ slot, hour, minute, t1, t2 });
    }

    samples.sort((a, b) => a.slot - b.slot);

    return {
      year,
      month,
      day,
      intervalMin,
      samples,
      totalSlotsPerDay
    };
  }

  function pad2(n) {
    return n < 10 ? '0' + n : '' + n;
  }

  function buildFullGrid(data) {
    const interval = data.intervalMin;
    const totalSlots = data.totalSlotsPerDay;
    const realBySlot = new Array(totalSlots).fill(null);

    data.samples.forEach(s => {
      if (s.slot >= 0 && s.slot < totalSlots) {
        realBySlot[s.slot] = { t1: s.t1, t2: s.t2 };
      }
    });

    let firstReal = -1;
    let lastReal  = -1;
    for (let i = 0; i < totalSlots; ++i) {
      if (realBySlot[i]) {
        firstReal = i;
        break;
      }
    }
    for (let i = totalSlots - 1; i >= 0; --i) {
      if (realBySlot[i]) {
        lastReal = i;
        break;
      }
    }

    if (firstReal === -1 || lastReal === -1) {
      return [];
    }

    const prevIdx = new Array(totalSlots).fill(-1);
    const nextIdx = new Array(totalSlots).fill(-1);

    let last = -1;
    for (let i = 0; i < totalSlots; ++i) {
      if (realBySlot[i]) last = i;
      prevIdx[i] = last;
    }

    last = -1;
    for (let i = totalSlots - 1; i >= 0; --i) {
      if (realBySlot[i]) last = i;
      nextIdx[i] = last;
    }

    const grid = [];
    for (let slot = firstReal; slot <= lastReal; ++slot) {
      const totalMinutes = slot * interval;
      const hour = Math.floor(totalMinutes / 60);
      const minute = totalMinutes % 60;

      let t1, t2;
      if (realBySlot[slot]) {
        t1 = realBySlot[slot].t1;
        t2 = realBySlot[slot].t2;
      } else {
        const p = prevIdx[slot];
        const n = nextIdx[slot];

        if (p === -1 && n === -1) {
          continue;
        } else if (p === -1) {
          t1 = realBySlot[n].t1;
          t2 = realBySlot[n].t2;
        } else if (n === -1) {
          t1 = realBySlot[p].t1;
          t2 = realBySlot[p].t2;
        } else {
          const span = n - p;
          const pos  = slot - p;
          const w    = span === 0 ? 0 : (pos / span);

          const t1p = realBySlot[p].t1;
          const t1n = realBySlot[n].t1;
          const t2p = realBySlot[p].t2;
          const t2n = realBySlot[n].t2;

          t1 = t1p + (t1n - t1p) * w;
          t2 = t2p + (t2n - t2p) * w;
        }
      }

      grid.push({ slot, hour, minute, t1, t2 });
    }

    return grid;
  }

  function renderData(data) {
    const dateStr = pad2(data.day) + '.' + pad2(data.month) + '.' + data.year;
    document.getElementById('infoDate').textContent = dateStr;
    document.getElementById('infoInterval').textContent = data.intervalMin + ' min';
    document.getElementById('infoSamples').textContent = data.samples.length;

    const grid = buildFullGrid(data);

    if (!grid.length) {
      document.getElementById('tableContainer').innerHTML = 'Brak próbek w danych QR.';
      return;
    }

    let html = '<table><thead><tr>' +
      '<th>Lp</th><th>Czas</th><th>T1 [°C]</th><th>T2 [°C]</th>' +
      '</tr></thead><tbody>';

    grid.forEach((row, idx) => {
      const timeStr = pad2(row.hour) + ':' + pad2(row.minute);
      const t1Str = (row.t1 !== null && row.t1 !== undefined) ? row.t1.toFixed(1) : '–';
      const t2Str = (row.t2 !== null && row.t2 !== undefined) ? row.t2.toFixed(1) : '–';

      html += '<tr>' +
        '<td>' + (idx + 1) + '</td>' +
        '<td>' + timeStr + '</td>' +
        '<td>' + t1Str + '</td>' +
        '<td>' + t2Str + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('tableContainer').innerHTML = html;
  }

  function processFromHash(hash) {
    showError('');
    clearInfo();

    const bParam = getBParamFromHash(hash);
    if (!bParam) {
      showError('Nie znaleziono danych w fragmencie adresu (hash). Oczekiwany format: "#<kod>" lub "#b=...&r=...".');
      return;
    }

    const rParam = getRParamFromHash(hash);
    if (rParam) {
      document.getElementById('infoRej').textContent = rParam;
    }

    try {
      const fullBytes = base64ToBytes(bParam);
      if (!fullBytes.length) {
        throw new Error('Brak bajtów po dekodowaniu Base64.');
      }

      let payloadBytes = fullBytes;
      const minPayloadWithoutCrc = 4;
      const hasPotentialCrc = fullBytes.length >= (minPayloadWithoutCrc + 4);

      if (hasPotentialCrc) {
        const dataLen = fullBytes.length - 4;
        const payload = fullBytes.slice(0, dataLen);
        const crcBytes = fullBytes.slice(dataLen);

        const crcExpected =
          ((crcBytes[0] << 24) >>> 0) |
          ((crcBytes[1] << 16) >>> 0) |
          ((crcBytes[2] << 8)  >>> 0) |
          (crcBytes[3] >>> 0);

        const crcCalc = crc32(payload);

        if (crcCalc !== crcExpected >>> 0) {
          showError('BŁĄD integralności: CRC32 się nie zgadza – dane zostały zmienione lub uszkodzone.');
          return;
        } else {
          showIntegrity('Integralność danych: OK (CRC32 zgodne).');
          payloadBytes = payload;
        }
      } else {
        showIntegrity('Integralność danych: brak CRC (starszy format QR).');
      }

      const data = decodePayload(payloadBytes);
      renderData(data);
    } catch (e) {
      console.error(e);
      showError('Błąd dekodowania: ' + e.message);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const currentHash = window.location.hash || '';

    const btnPrint = document.getElementById('btnPrint');
    if (btnPrint) {
      btnPrint.addEventListener('click', () => {
        window.print();
      });
    }

    const btnSendLink = document.getElementById('btnSendLink');
    if (btnSendLink) {
      btnSendLink.addEventListener('click', () => {
        const url = window.location.href;
        const subject = 'Raport temperatur z rejestratora OUTBOX';
        const body = 'Link do raportu z rejestratora OUTBOX:\n' + url;
        const mailto = 'mailto:?subject=' +
          encodeURIComponent(subject) +
          '&body=' +
          encodeURIComponent(body);
        window.location.href = mailto;
      });
    }

    if (currentHash) {
      processFromHash(currentHash);
    } else {
      showError('Brak danych do testu integralności. Strona powinna zostać otwarta z linku w kodzie QR rejestratora.');
    }
  });
</script>

</body>
</html>
