<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Log temperatury z QR</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.3rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.2rem;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .info-row {
      margin: 4px 0;
    }
    .info-label {
      font-weight: 600;
    }
    .error {
      color: #b00020;
      font-weight: 600;
      margin-top: 8px;
    }
    .ok {
      color: #2e7d32;
      font-weight: 600;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }

    /* --- LOGO OUTBOX --- */
    .logo-card {
      text-align: center;
    }
    .logo-main {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.14em;
      color: #000000;
    }
    .logo-sub {
      font-size: 12px;
      margin-top: 4px;
      color: #000000;
    }
  </style>
</head>
<body>

  <!-- KARTA Z LOGO I KRÓTKIM OPISem -->
  <div class="card logo-card">
    <div class="logo-main">OUTBOX</div>
    <div class="logo-sub">rejestrator temperatury</div>
    <div class="small" style="margin-top:10px;">
      Raport wygenerowany automatycznie z danych zapisanych w rejestratorze OUTBOX
      na podstawie kodu QR z wydruku.
    </div>
  </div>

  <!-- TYLKO INTEGRALNOŚĆ DANYCH – BEZ POLA DO WPISYWANIA -->
  <div class="card">
    <h2>Integralność danych</h2>
    <div class="small">
      Dane poniżej pochodzą bezpośrednio z zakodowanego ciągu w QR.
      Dla nowych wydruków sprawdzana jest zgodność CRC32 – zmiana danych powoduje błąd.
    </div>
    <div id="errorBox" class="error" style="display:none;"></div>
    <div id="integrityBox" class="ok" style="display:none;"></div>
  </div>

  <div class="card">
    <h2>Informacje o logu</h2>
    <div class="info-row"><span class="info-label">Data:</span> <span id="infoDate">–</span></div>
    <div class="info-row"><span class="info-label">Rejestracja:</span> <span id="infoRej">–</span></div>
    <div class="info-row"><span class="info-label">Interwał logu:</span> <span id="infoInterval">–</span></div>
    <div class="info-row"><span class="info-label">Próbek w QR (baza+alarmy):</span> <span id="infoSamples">–</span></div>
  </div>

  <div class="card">
    <h2>Tabela temperatur (co 15 min)</h2>
    <div id="tableContainer">
      Brak danych – otwórz tę stronę skanując kod QR z wydruku rejestratora OUTBOX.
    </div>
  </div>

<script>
  function showError(msg) {
    const box = document.getElementById('errorBox');
    const ibox = document.getElementById('integrityBox');
    box.textContent = msg || '';
    box.style.display = msg ? 'block' : 'none';
    // przy błędzie chowamy komunikat o integralności
    if (msg) {
      ibox.textContent = '';
      ibox.style.display = 'none';
    }
  }

  function showIntegrity(msg) {
    const ibox = document.getElementById('integrityBox');
    ibox.textContent = msg || '';
    ibox.style.display = msg ? 'block' : 'none';
  }

  function clearInfo() {
    document.getElementById('infoDate').textContent = '–';
    document.getElementById('infoRej').textContent = '–';
    document.getElementById('infoInterval').textContent = '–';
    document.getElementById('infoSamples').textContent = '–';
    document.getElementById('tableContainer').innerHTML =
      'Brak danych – otwórz tę stronę skanując kod QR z wydruku rejestratora OUTBOX.';
    showIntegrity('');
  }

  // Obsługa obu formatów:
  // 1) nowy: "#<b64url>.<rej>" lub "#<b64url>"
  // 2) stary: "#b=...&r=..."
  function getBParamFromHash(rawHash) {
    if (!rawHash) return null;
    let h = rawHash;
    if (h.startsWith('#')) h = h.substring(1);
    if (!h) return null;

    // stary format: query string "b=...&r=..."
    if (h.includes('=')) {
      const parts = h.split('&');
      for (const part of parts) {
        const [k, v] = part.split('=');
        if (k === 'b') {
          return v ? decodeURIComponent(v) : '';
        }
      }
      return null;
    }

    // nowy format: "<b64url>" lub "<b64url>.<rej>"
    const parts = h.split('.');
    const b64 = parts[0] || '';
    return b64 || null;
  }

  function getRParamFromHash(rawHash) {
    if (!rawHash) return null;
    let h = rawHash;
    if (h.startsWith('#')) h = h.substring(1);
    if (!h
